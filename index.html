import React, { useState, useEffect, useRef, useMemo } from 'react';

const POPULATION = 8e9;

function DegreesOfHelp() {
  const [k, setK] = useState(5);
  const [currentWave, setCurrentWave] = useState(0);
  const [isPlaying, setIsPlaying] = useState(false);
  const [overlap, setOverlap] = useState(0);
  const [isolation, setIsolation] = useState(0);
  const canvasRef = useRef(null);
  const animationRef = useRef(null);
  const nodesRef = useRef([]);

  // Calculate waves needed
  const wavesNeeded = useMemo(() => {
    let t = 0;
    let helped = 1;
    const effectiveK = k * (1 - overlap * 0.5);
    const reachable = POPULATION * (1 - isolation);
    while (helped < reachable && t < 100) {
      helped += Math.pow(effectiveK, t + 1);
      t++;
    }
    return t;
  }, [k, overlap, isolation]);

  // Calculate helped at current wave
  const helpedAtWave = useMemo(() => {
    if (currentWave === 0) return 1;
    const effectiveK = k * (1 - overlap * 0.5);
    let total = 0;
    for (let i = 0; i <= currentWave; i++) {
      total += Math.pow(effectiveK, i);
    }
    return Math.min(total, POPULATION * (1 - isolation));
  }, [currentWave, k, overlap, isolation]);

  const percentHelped = (helpedAtWave / POPULATION) * 100;

  // Animation
  useEffect(() => {
    if (isPlaying && currentWave < wavesNeeded) {
      const timeout = setTimeout(() => {
        setCurrentWave(w => w + 1);
      }, 600);
      return () => clearTimeout(timeout);
    } else if (currentWave >= wavesNeeded) {
      setIsPlaying(false);
    }
  }, [isPlaying, currentWave, wavesNeeded]);

  // Canvas visualization
  useEffect(() => {
    const canvas = canvasRef.current;
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;
    const centerX = width / 2;
    const centerY = height / 2;

    // Initialize nodes on first render or k change
    if (nodesRef.current.length === 0 || nodesRef.current.k !== k) {
      const nodes = [];
      const maxNodes = 500;
      
      // Create hierarchical layout
      nodes.push({ x: centerX, y: centerY, wave: 0, connections: [] });
      
      let currentIndex = 0;
      for (let wave = 1; wave <= 6; wave++) {
        const nodesInWave = Math.min(Math.pow(k, wave), maxNodes - nodes.length);
        const radius = wave * 55;
        
        for (let i = 0; i < nodesInWave && nodes.length < maxNodes; i++) {
          const angle = (i / nodesInWave) * Math.PI * 2 + (wave * 0.3);
          const jitter = (Math.random() - 0.5) * 20;
          const x = centerX + Math.cos(angle) * (radius + jitter);
          const y = centerY + Math.sin(angle) * (radius + jitter);
          
          // Find parent from previous wave
          const parentWaveStart = wave === 1 ? 0 : nodes.findIndex(n => n.wave === wave - 1);
          const parentWaveEnd = nodes.filter(n => n.wave === wave - 1).length;
          const parentIndex = parentWaveStart + (i % parentWaveEnd);
          
          nodes.push({ x, y, wave, parent: parentIndex });
        }
      }
      
      nodesRef.current = nodes;
      nodesRef.current.k = k;
    }

    const draw = () => {
      ctx.fillStyle = '#0a0a0f';
      ctx.fillRect(0, 0, width, height);

      // Draw subtle grid
      ctx.strokeStyle = 'rgba(255, 180, 100, 0.03)';
      ctx.lineWidth = 1;
      for (let i = 0; i < width; i += 40) {
        ctx.beginPath();
        ctx.moveTo(i, 0);
        ctx.lineTo(i, height);
        ctx.stroke();
      }
      for (let i = 0; i < height; i += 40) {
        ctx.beginPath();
        ctx.moveTo(0, i);
        ctx.lineTo(width, i);
        ctx.stroke();
      }

      const nodes = nodesRef.current;

      // Draw connections first
      nodes.forEach((node, idx) => {
        if (node.parent !== undefined && node.wave <= currentWave) {
          const parent = nodes[node.parent];
          const progress = Math.min(1, (currentWave - node.wave + 1));
          
          ctx.beginPath();
          ctx.moveTo(parent.x, parent.y);
          ctx.lineTo(
            parent.x + (node.x - parent.x) * progress,
            parent.y + (node.y - parent.y) * progress
          );
          
          const alpha = node.wave <= currentWave ? 0.3 : 0.05;
          ctx.strokeStyle = `rgba(255, 180, 100, ${alpha})`;
          ctx.lineWidth = 1;
          ctx.stroke();
        }
      });

      // Draw nodes
      nodes.forEach((node, idx) => {
        const isActive = node.wave <= currentWave;
        const isCurrentWave = node.wave === currentWave;
        
        // Glow effect for active nodes
        if (isActive) {
          const gradient = ctx.createRadialGradient(
            node.x, node.y, 0,
            node.x, node.y, isCurrentWave ? 25 : 15
          );
          
          if (node.wave === 0) {
            gradient.addColorStop(0, 'rgba(255, 220, 150, 0.8)');
            gradient.addColorStop(0.5, 'rgba(255, 180, 100, 0.3)');
            gradient.addColorStop(1, 'rgba(255, 140, 50, 0)');
          } else {
            const intensity = isCurrentWave ? 0.6 : 0.3;
            gradient.addColorStop(0, `rgba(255, 200, 130, ${intensity})`);
            gradient.addColorStop(0.5, `rgba(255, 160, 80, ${intensity * 0.5})`);
            gradient.addColorStop(1, 'rgba(255, 120, 50, 0)');
          }
          
          ctx.beginPath();
          ctx.arc(node.x, node.y, isCurrentWave ? 25 : 15, 0, Math.PI * 2);
          ctx.fillStyle = gradient;
          ctx.fill();
        }

        // Core node
        ctx.beginPath();
        const size = node.wave === 0 ? 6 : (isCurrentWave ? 4 : 3);
        ctx.arc(node.x, node.y, size, 0, Math.PI * 2);
        
        if (isActive) {
          ctx.fillStyle = node.wave === 0 ? '#ffe4b5' : '#ffb060';
        } else {
          ctx.fillStyle = 'rgba(100, 80, 60, 0.3)';
        }
        ctx.fill();
      });

      // Draw wave rings
      for (let i = 1; i <= currentWave && i <= 6; i++) {
        ctx.beginPath();
        ctx.arc(centerX, centerY, i * 55, 0, Math.PI * 2);
        ctx.strokeStyle = `rgba(255, 180, 100, ${0.1 - i * 0.01})`;
        ctx.lineWidth = 1;
        ctx.stroke();
      }
    };

    draw();
  }, [currentWave, k]);

  const reset = () => {
    setCurrentWave(0);
    setIsPlaying(false);
  };

  const formatNumber = (n) => {
    if (n >= 1e9) return (n / 1e9).toFixed(2) + 'B';
    if (n >= 1e6) return (n / 1e6).toFixed(2) + 'M';
    if (n >= 1e3) return (n / 1e3).toFixed(1) + 'K';
    return Math.floor(n).toString();
  };

  return (
    <div style={{
      minHeight: '100vh',
      backgroundColor: '#0a0a0f',
      color: '#e8e0d5',
      fontFamily: '"EB Garamond", Georgia, serif',
      padding: '40px 20px',
    }}>
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,600;1,400&family=JetBrains+Mono:wght@400;500&display=swap');
        
        * { box-sizing: border-box; }
        
        input[type="range"] {
          -webkit-appearance: none;
          appearance: none;
          background: transparent;
          cursor: pointer;
          width: 100%;
        }
        
        input[type="range"]::-webkit-slider-track {
          background: rgba(255, 180, 100, 0.2);
          height: 4px;
          border-radius: 2px;
        }
        
        input[type="range"]::-webkit-slider-thumb {
          -webkit-appearance: none;
          appearance: none;
          width: 16px;
          height: 16px;
          border-radius: 50%;
          background: #ffb060;
          margin-top: -6px;
          box-shadow: 0 0 10px rgba(255, 180, 100, 0.5);
        }
        
        input[type="range"]::-moz-range-track {
          background: rgba(255, 180, 100, 0.2);
          height: 4px;
          border-radius: 2px;
        }
        
        input[type="range"]::-moz-range-thumb {
          width: 16px;
          height: 16px;
          border-radius: 50%;
          background: #ffb060;
          border: none;
          box-shadow: 0 0 10px rgba(255, 180, 100, 0.5);
        }

        .stat-card {
          background: linear-gradient(135deg, rgba(255, 180, 100, 0.08) 0%, rgba(255, 140, 60, 0.03) 100%);
          border: 1px solid rgba(255, 180, 100, 0.15);
          border-radius: 8px;
          padding: 20px;
          text-align: center;
        }

        .control-section {
          background: rgba(255, 255, 255, 0.02);
          border: 1px solid rgba(255, 180, 100, 0.1);
          border-radius: 8px;
          padding: 20px;
          margin-bottom: 16px;
        }

        button {
          font-family: 'JetBrains Mono', monospace;
          font-size: 13px;
          padding: 12px 24px;
          border: 1px solid rgba(255, 180, 100, 0.3);
          background: rgba(255, 180, 100, 0.1);
          color: #ffb060;
          border-radius: 4px;
          cursor: pointer;
          transition: all 0.2s ease;
        }

        button:hover {
          background: rgba(255, 180, 100, 0.2);
          border-color: rgba(255, 180, 100, 0.5);
          box-shadow: 0 0 20px rgba(255, 180, 100, 0.2);
        }

        .progress-bar {
          height: 8px;
          background: rgba(255, 180, 100, 0.1);
          border-radius: 4px;
          overflow: hidden;
          margin-top: 20px;
        }

        .progress-fill {
          height: 100%;
          background: linear-gradient(90deg, #ff8040, #ffb060);
          border-radius: 4px;
          transition: width 0.5s ease;
        }

        .formula {
          font-family: 'JetBrains Mono', monospace;
          font-size: 13px;
          color: rgba(255, 180, 100, 0.7);
          background: rgba(0, 0, 0, 0.3);
          padding: 12px 16px;
          border-radius: 4px;
          margin: 16px 0;
        }
      `}</style>

      <div style={{ maxWidth: '1100px', margin: '0 auto' }}>
        {/* Header */}
        <header style={{ textAlign: 'center', marginBottom: '50px' }}>
          <h1 style={{
            fontSize: 'clamp(32px, 5vw, 48px)',
            fontWeight: 500,
            letterSpacing: '-0.02em',
            marginBottom: '16px',
            background: 'linear-gradient(135deg, #ffe4b5 0%, #ffb060 50%, #ff8040 100%)',
            WebkitBackgroundClip: 'text',
            WebkitTextFillColor: 'transparent',
            backgroundClip: 'text',
          }}>
            Degrees of Help
          </h1>
          <p style={{
            fontSize: '18px',
            color: 'rgba(232, 224, 213, 0.6)',
            fontStyle: 'italic',
            maxWidth: '600px',
            margin: '0 auto',
            lineHeight: 1.6,
          }}>
            If we treated kindness like a protocol instead of a vibe,<br />
            how many hops away from "everyone's been helped" are we?
          </p>
        </header>

        {/* Main Grid */}
        <div style={{
          display: 'grid',
          gridTemplateColumns: 'minmax(300px, 400px) 1fr',
          gap: '40px',
          alignItems: 'start',
        }}>
          {/* Controls Panel */}
          <div>
            <div className="control-section">
              <label style={{
                display: 'block',
                fontSize: '14px',
                color: 'rgba(255, 180, 100, 0.8)',
                marginBottom: '12px',
                fontFamily: '"JetBrains Mono", monospace',
              }}>
                People helped per person: <strong style={{ color: '#ffb060', fontSize: '18px' }}>{k}</strong>
              </label>
              <input
                type="range"
                min="2"
                max="20"
                value={k}
                onChange={(e) => { setK(Number(e.target.value)); reset(); }}
              />
              <div style={{
                display: 'flex',
                justifyContent: 'space-between',
                fontSize: '11px',
                color: 'rgba(255, 180, 100, 0.4)',
                marginTop: '4px',
                fontFamily: '"JetBrains Mono", monospace',
              }}>
                <span>2</span>
                <span>20</span>
              </div>
            </div>

            <div className="control-section">
              <label style={{
                display: 'block',
                fontSize: '14px',
                color: 'rgba(255, 180, 100, 0.8)',
                marginBottom: '12px',
                fontFamily: '"JetBrains Mono", monospace',
              }}>
                Network overlap: <strong style={{ color: '#ffb060' }}>{Math.round(overlap * 100)}%</strong>
              </label>
              <input
                type="range"
                min="0"
                max="0.8"
                step="0.05"
                value={overlap}
                onChange={(e) => { setOverlap(Number(e.target.value)); reset(); }}
              />
              <p style={{ fontSize: '12px', color: 'rgba(232, 224, 213, 0.4)', marginTop: '8px', lineHeight: 1.5 }}>
                How much people cluster—helping friends of friends
              </p>
            </div>

            <div className="control-section">
              <label style={{
                display: 'block',
                fontSize: '14px',
                color: 'rgba(255, 180, 100, 0.8)',
                marginBottom: '12px',
                fontFamily: '"JetBrains Mono", monospace',
              }}>
                Isolation factor: <strong style={{ color: '#ffb060' }}>{Math.round(isolation * 100)}%</strong>
              </label>
              <input
                type="range"
                min="0"
                max="0.5"
                step="0.05"
                value={isolation}
                onChange={(e) => { setIsolation(Number(e.target.value)); reset(); }}
              />
              <p style={{ fontSize: '12px', color: 'rgba(232, 224, 213, 0.4)', marginTop: '8px', lineHeight: 1.5 }}>
                Unreachable nodes—remote, isolated, blocked from help
              </p>
            </div>

            <div style={{ display: 'flex', gap: '12px', marginTop: '24px' }}>
              <button onClick={() => setIsPlaying(!isPlaying)}>
                {isPlaying ? '⏸ Pause' : '▶ Play'}
              </button>
              <button onClick={reset}>
                ↺ Reset
              </button>
              <button onClick={() => setCurrentWave(w => Math.min(w + 1, wavesNeeded))}>
                +1 Wave
              </button>
            </div>
          </div>

          {/* Visualization */}
          <div>
            <canvas
              ref={canvasRef}
              width={500}
              height={400}
              style={{
                width: '100%',
                height: 'auto',
                borderRadius: '8px',
                border: '1px solid rgba(255, 180, 100, 0.1)',
              }}
            />
          </div>
        </div>

        {/* Stats Row */}
        <div style={{
          display: 'grid',
          gridTemplateColumns: 'repeat(auto-fit, minmax(180px, 1fr))',
          gap: '16px',
          marginTop: '40px',
        }}>
          <div className="stat-card">
            <div style={{
              fontSize: '11px',
              textTransform: 'uppercase',
              letterSpacing: '0.1em',
              color: 'rgba(255, 180, 100, 0.6)',
              marginBottom: '8px',
              fontFamily: '"JetBrains Mono", monospace',
            }}>Current Wave</div>
            <div style={{
              fontSize: '36px',
              fontWeight: 600,
              color: '#ffb060',
            }}>{currentWave}</div>
          </div>

          <div className="stat-card">
            <div style={{
              fontSize: '11px',
              textTransform: 'uppercase',
              letterSpacing: '0.1em',
              color: 'rgba(255, 180, 100, 0.6)',
              marginBottom: '8px',
              fontFamily: '"JetBrains Mono", monospace',
            }}>Waves Needed</div>
            <div style={{
              fontSize: '36px',
              fontWeight: 600,
              color: '#ffe4b5',
            }}>{wavesNeeded}</div>
          </div>

          <div className="stat-card">
            <div style={{
              fontSize: '11px',
              textTransform: 'uppercase',
              letterSpacing: '0.1em',
              color: 'rgba(255, 180, 100, 0.6)',
              marginBottom: '8px',
              fontFamily: '"JetBrains Mono", monospace',
            }}>People Helped</div>
            <div style={{
              fontSize: '36px',
              fontWeight: 600,
              color: '#ffb060',
            }}>{formatNumber(helpedAtWave)}</div>
          </div>

          <div className="stat-card">
            <div style={{
              fontSize: '11px',
              textTransform: 'uppercase',
              letterSpacing: '0.1em',
              color: 'rgba(255, 180, 100, 0.6)',
              marginBottom: '8px',
              fontFamily: '"JetBrains Mono", monospace',
            }}>Coverage</div>
            <div style={{
              fontSize: '36px',
              fontWeight: 600,
              color: percentHelped >= 100 ? '#90ee90' : '#ffb060',
            }}>{percentHelped >= 100 ? '100' : percentHelped.toFixed(percentHelped < 1 ? 6 : 2)}%</div>
          </div>
        </div>

        {/* Progress bar */}
        <div className="progress-bar">
          <div
            className="progress-fill"
            style={{ width: `${Math.min(percentHelped, 100)}%` }}
          />
        </div>

        {/* Formula */}
        <div className="formula" style={{ marginTop: '30px', textAlign: 'center' }}>
          H(t) = Σ k<sup>i</sup> for i=0 to t ≈ (k<sup>t+1</sup> - 1) / (k - 1)
          <span style={{ marginLeft: '20px', opacity: 0.6 }}>→</span>
          <span style={{ marginLeft: '20px' }}>
            t ≈ log<sub>{k}</sub>(8×10<sup>9</sup>) ≈ <strong>{wavesNeeded}</strong> waves
          </span>
        </div>

        {/* Insight */}
        <div style={{
          marginTop: '40px',
          padding: '30px',
          background: 'rgba(255, 180, 100, 0.03)',
          borderLeft: '3px solid rgba(255, 180, 100, 0.3)',
          borderRadius: '0 8px 8px 0',
        }}>
          <p style={{
            fontSize: '18px',
            lineHeight: 1.8,
            color: 'rgba(232, 224, 213, 0.85)',
            margin: 0,
          }}>
            <strong style={{ color: '#ffb060' }}>The math says:</strong> In an ideal world, 
            {k === 2 ? ' just 33 layers' : k <= 5 ? ` only ${wavesNeeded} layers` : ` merely ${wavesNeeded} layers`} of 
            "I was helped, now I help {k} more" covers all of humanity.
            <br /><br />
            <strong style={{ color: '#ffb060' }}>The ethics say:</strong> The bottleneck isn't math—it's will, structure, and access.
          </p>
        </div>

        {/* Footer */}
        <footer style={{
          marginTop: '60px',
          textAlign: 'center',
          fontSize: '13px',
          color: 'rgba(232, 224, 213, 0.3)',
          fontFamily: '"JetBrains Mono", monospace',
        }}>
          Moral epidemiology · Degrees of separation → Degrees of help
        </footer>
      </div>
    </div>
  );
}

export default DegreesOfHelp;
